name: Publish to crates.io

on:
  workflow_call:
    inputs:
      package:
        description: "Package name to publish (e.g., pubmed-client, pubmed-cli)"
        required: true
        type: string
      package-path:
        description: "Path to the package directory (e.g., pubmed-client, pubmed-cli)"
        required: false
        type: string
        default: ""
      dry-run:
        description: "Perform a dry run without actually publishing"
        required: false
        type: boolean
        default: false
      check-version:
        description: "Check if version matches tag before publishing"
        required: false
        type: boolean
        default: true
    secrets:
      CRATES_IO_TOKEN:
        description: "Token for publishing to crates.io"
        required: true

jobs:
  publish:
    name: Publish ${{ inputs.package }} to crates.io
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          persist-credentials: false

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          key: ${{ inputs.package }}

      - name: Get package path
        id: pkg-path
        env:
          PKG_PATH: ${{ inputs.package-path }}
          PKG_NAME: ${{ inputs.package }}
        run: |
          if [ -z "$PKG_PATH" ]; then
            echo "path=$PKG_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "path=$PKG_PATH" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract version from tag
        id: tag-version
        if: inputs.check-version
        env:
          PKG_NAME: ${{ inputs.package }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix if present
          VERSION=${TAG#v}
          # Extract version if tag follows pattern like 'package-name-v1.0.0'
          if [[ $TAG == *"$PKG_NAME"* ]]; then
            VERSION=${TAG##*-v}
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Tag version: $VERSION"

      - name: Check Cargo.toml version
        id: cargo-version
        if: inputs.check-version
        working-directory: ${{ steps.pkg-path.outputs.path }}
        run: |
          # Match only 'version = "..."', not 'version.workspace = true'
          VERSION=$(grep -m1 '^version\s*=' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          # If empty, package uses workspace inheritance - read from workspace root
          if [ -z "$VERSION" ]; then
            VERSION=$(grep -m1 '^version\s*=' "$GITHUB_WORKSPACE/Cargo.toml" | sed 's/.*"\(.*\)".*/\1/')
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Cargo.toml version: $VERSION"

      - name: Verify version match
        if: inputs.check-version
        env:
          TAG_VERSION: ${{ steps.tag-version.outputs.version }}
          CARGO_VERSION: ${{ steps.cargo-version.outputs.version }}
        run: |
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Version mismatch! Tag: $TAG_VERSION, Cargo.toml: $CARGO_VERSION"
            exit 1
          fi
          echo "✓ Version match confirmed: $CARGO_VERSION"

      - name: Validate package
        working-directory: ${{ steps.pkg-path.outputs.path }}
        env:
          PKG_NAME: ${{ inputs.package }}
        run: |
          echo "Validating package: $PKG_NAME"
          cargo package --list
          cargo package --allow-dirty

      - name: Publish to crates.io (dry-run)
        if: ${{ inputs.dry-run }}
        working-directory: ${{ steps.pkg-path.outputs.path }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
          PKG_NAME: ${{ inputs.package }}
        run: |
          echo "Dry run - would publish: $PKG_NAME"
          cargo publish --dry-run --token "$CARGO_REGISTRY_TOKEN"

      - name: Publish to crates.io
        if: ${{ !inputs.dry-run }}
        working-directory: ${{ steps.pkg-path.outputs.path }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
          PKG_NAME: ${{ inputs.package }}
        run: |
          echo "Publishing package: $PKG_NAME"
          cargo publish --token "$CARGO_REGISTRY_TOKEN"

      - name: Publish summary
        if: ${{ !inputs.dry-run }}
        env:
          PKG_NAME: ${{ inputs.package }}
          PKG_VERSION: ${{ steps.cargo-version.outputs.version }}
        run: |
          {
            echo "### ✅ Published to crates.io"
            echo ""
            echo "- **Package**: $PKG_NAME"
            echo "- **Version**: $PKG_VERSION"
            echo "- **crates.io**: https://crates.io/crates/$PKG_NAME"
          } >> "$GITHUB_STEP_SUMMARY"
