name: Integration Tests

# Run integration tests on schedule and manual trigger
# These tests make real API calls to NCBI, so they run separately from regular CI
on:
  # Run daily at 06:00 UTC to catch API changes
  schedule:
    - cron: "0 6 * * *"

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      test_type:
        description: "Type of integration tests to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - pubmed
          - pmc
          - error-handling

      use_api_key:
        description: "Use NCBI API key for higher rate limits"
        required: false
        default: true
        type: boolean

  # Run on PRs with specific label
  pull_request:
    types: [labeled]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Check if integration tests should run
  check-trigger:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      test_type: ${{ steps.check.outputs.test_type }}
      use_api_key: ${{ steps.check.outputs.use_api_key }}
    steps:
      - name: Check if integration tests should run
        id: check
        run: |
          # Always run on schedule or manual dispatch
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            {
              echo "should_run=true"
              echo "test_type=${{ github.event.inputs.test_type || 'all' }}"
              echo "use_api_key=${{ github.event.inputs.use_api_key || 'true' }}"
            } >> "$GITHUB_OUTPUT"
          # Run on PRs with integration-tests label
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'test-integration') }}" == "true" ]]; then
              {
                echo "should_run=true"
                echo "test_type=all"
                echo "use_api_key=true"
              } >> "$GITHUB_OUTPUT"
            else
              echo "should_run=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  # Integration tests job
  integration-tests:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30 # Integration tests can take longer due to rate limiting

    strategy:
      fail-fast: false
      matrix:
        rust-version: [stable]
        # Only run on Ubuntu for integration tests to limit API usage

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          persist-credentials: false

      - uses: ./.github/actions/setup-repo

      - name: Setup integration test environment
        run: |
          # Set required environment variables
          {
            echo "PUBMED_REAL_API_TESTS=1"
            echo "RUST_LOG=info"
          } >> "$GITHUB_ENV"

          # Set API key if available and requested
          if [[ "${{ needs.check-trigger.outputs.use_api_key }}" == "true" && -n "${{ secrets.NCBI_API_KEY }}" ]]; then
            echo "NCBI_API_KEY=${{ secrets.NCBI_API_KEY }}" >> "$GITHUB_ENV"
            echo "Using NCBI API key for higher rate limits"
          else
            echo "Running without API key (standard rate limits)"
          fi

      - name: Build with integration-tests feature
        run: |
          cargo build --features integration-tests --tests
          echo "Build completed successfully"

      - name: Run PubMed integration tests
        if: needs.check-trigger.outputs.test_type == 'all' || needs.check-trigger.outputs.test_type == 'pubmed'
        run: |
          echo "Running PubMed API integration tests..."
          cargo nextest run --features integration-tests --test pubmed_api_tests \
            --test-threads 1 \
            --no-capture \
            --verbose
        continue-on-error: true # Don't fail the workflow if some tests fail due to API issues

      - name: Run PMC integration tests
        if: needs.check-trigger.outputs.test_type == 'all' || needs.check-trigger.outputs.test_type == 'pmc'
        run: |
          echo "Running PMC API integration tests..."
          cargo nextest run --features integration-tests --test pmc_api_tests \
            --test-threads 1 \
            --no-capture \
            --verbose
        continue-on-error: true

      - name: Run error handling integration tests
        if: needs.check-trigger.outputs.test_type == 'all' || needs.check-trigger.outputs.test_type == 'error-handling'
        run: |
          echo "Running error handling integration tests..."
          cargo nextest run --features integration-tests --test error_handling_tests \
            --test-threads 1 \
            --no-capture \
            --verbose
        continue-on-error: true

      - name: Run existing real API tests for comparison
        if: needs.check-trigger.outputs.test_type == 'all'
        run: |
          echo "Running existing real API tests for comparison..."
          cargo nextest run --test test_real_api_rate_limiting \
            --test-threads 1 \
            --no-capture \
            --verbose
        continue-on-error: true

      - name: Generate integration test summary
        if: always()
        run: |
          {
            echo "## Integration Test Summary"
            echo ""
            echo "**Test Configuration:**"
            echo "- Test Type: ${{ needs.check-trigger.outputs.test_type }}"
            echo "- API Key Used: ${{ needs.check-trigger.outputs.use_api_key }}"
            echo "- Rust Version: ${{ matrix.rust-version }}"
            echo ""
            echo "**Test Execution:**"
            echo "- Started: $(date -u)"
            echo "- Trigger: ${{ github.event_name }}"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "- Type: Scheduled daily run" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "- Type: Manual trigger" >> "$GITHUB_STEP_SUMMARY"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "- Type: PR with integration-tests label" >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "**Notes:**"
            echo "- Tests may fail due to network issues or API changes"
            echo "- Rate limiting is enforced to be respectful to NCBI servers"
            echo "- Individual test failures don't fail the workflow"
          } >> "$GITHUB_STEP_SUMMARY"

  # Notification job for scheduled runs
  notify-results:
    needs: [check-trigger, integration-tests]
    if: always() && needs.check-trigger.outputs.should_run == 'true' && github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions: {}
    timeout-minutes: 5
    steps:
      - name: Report scheduled test results
        run: |
          if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
            echo "✅ Scheduled integration tests completed successfully"
          else
            echo "⚠️ Scheduled integration tests encountered issues"
            echo "This may indicate API changes or network issues"
            echo "Please review the test results and update if necessary"
          fi

          echo "Integration test workflow completed for scheduled run"
          echo "Next scheduled run: Tomorrow at 06:00 UTC"
