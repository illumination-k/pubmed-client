name: "CI / Benchmark"

on:
  pull_request:
    branches: [main]
    paths:
      - "pubmed-parser/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/ci-bench.yml"

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Criterion Benchmark
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          fetch-depth: 0
          persist-credentials: true

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: bench

      # 1. Run benchmarks on base branch and save as baseline
      - name: Checkout base branch
        run: git checkout ${{ github.base_ref }}

      - name: Run base benchmarks
        run: cargo bench -p pubmed-parser -- --save-baseline base

      # 2. Run benchmarks on PR branch, comparing against base
      - name: Checkout PR branch
        run: git checkout ${{ github.event.pull_request.head.sha }}

      - name: Run PR benchmarks
        run: |
          cargo bench -p pubmed-parser -- --baseline base 2>&1 | tee bench_output.txt

      # 3. Extract comparison results and post as PR comment
      - name: Post benchmark comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('bench_output.txt', 'utf8');

            // Extract only the benchmark result lines (filter out compilation/warning noise)
            const lines = output.split('\n');
            const benchLines = lines.filter(line =>
              line.includes('time:') ||
              line.includes('thrpt:') ||
              line.includes('change:') ||
              line.includes('Performance has') ||
              line.includes('No change') ||
              line.includes('Found') ||
              line.includes('Benchmarking') ||
              line.match(/^[\w_\/]+$/)
            );

            const result = benchLines.join('\n').trim();
            if (!result) {
              console.log('No benchmark results found');
              return;
            }

            const body = [
              '## Benchmark Results (vs `' + context.payload.pull_request.base.ref + '`)',
              '',
              '> CI環境のベンチマークはノイズが大きいため参考値です。有意な変化はローカルで再検証してください。',
              '',
              '```',
              result,
              '```',
            ].join('\n');

            // Update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const marker = '## Benchmark Results';
            const existing = comments.find(c => c.body && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
