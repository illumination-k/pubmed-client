name: Documentation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - "pubmed-client/src/**"
      - "pubmed-client/Cargo.toml"
      - "pubmed-client-napi/**"
      - "pubmed-client-py/**"
      - "website/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/docs.yml"
      - ".github/actions/setup-repo/**"

env:
  MISE_EXPERIMENTAL: true

jobs:
  docs:
    name: Build Rust Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo
        with:
          setup-mise: "false"

      - name: Build docs
        run: cargo doc --all-features --no-deps
        env:
          RUSTDOCFLAGS: "-D warnings --cfg docsrs"
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"

      - name: Upload Rust docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: rust-docs
          path: target/doc/

  node-docs:
    name: Build Node.js Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    env:
      MISE_ENV: node
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo

      - name: Install NAPI dependencies
        run: pnpm install --frozen-lockfile
        working-directory: pubmed-client-napi

      - name: Build NAPI package (generates index.d.ts)
        run: pnpm run build:debug
        working-directory: pubmed-client-napi

      - name: Build Node.js docs
        run: pnpm run docs
        working-directory: pubmed-client-napi

      - name: Upload Node.js docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: node-docs
          path: pubmed-client-napi/docs/

  python-docs:
    name: Build Python Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30
    env:
      MISE_ENV: python
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo

      - name: Pin Python version
        run: uv python pin 3.12

      - name: Install Python dependencies
        run: uv sync --group docs
        working-directory: pubmed-client-py

      - name: Build Python package
        run: uv run --with maturin maturin develop
        working-directory: pubmed-client-py

      - name: Build Sphinx documentation
        run: uv run sphinx-build -b html docs/source docs/build/html
        working-directory: pubmed-client-py

      - name: Upload Python docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: python-docs
          path: pubmed-client-py/docs/build/html/

  website-lint:
    name: Website Lint and Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    env:
      MISE_ENV: node
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo

      - name: Install website dependencies
        run: pnpm install --frozen-lockfile
        working-directory: website

      - name: Lint website
        run: pnpm run ci
        working-directory: website

      - name: Type check website
        run: pnpm run typecheck
        working-directory: website

  build-site:
    name: Build GitHub Pages Site
    runs-on: ubuntu-latest
    needs: [docs, node-docs, python-docs, website-lint]
    permissions:
      contents: read
    timeout-minutes: 15
    env:
      MISE_ENV: node
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo

      - name: Install website dependencies
        run: pnpm install --frozen-lockfile
        working-directory: website

      - name: Build Docusaurus site
        run: pnpm run build
        working-directory: website

      - name: Download Rust docs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: rust-docs
          path: website/build/rust/

      - name: Download Node.js docs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: node-docs
          path: website/build/node/

      - name: Download Python docs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: python-docs
          path: website/build/python/

      - name: Create Rust docs redirect
        run: |
          printf '<html><head><meta http-equiv="refresh" content="0;url=pubmed_client/index.html"></head><body><a href="pubmed_client/index.html">Rust API docs</a></body></html>' \
            > website/build/rust/index.html

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: website/build/

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-site
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
