name: Documentation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  docs:
    name: Build Rust Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo
        with:
          lfs: "false"

      - name: Build docs
        run: cargo doc --all-features --no-deps
        env:
          RUSTDOCFLAGS: "-D warnings --cfg docsrs"
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"

      - name: Upload Rust docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: rust-docs
          path: target/doc/

  node-docs:
    name: Build Node.js Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo
        with:
          lfs: "false"

      - name: Cache pnpm store
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.pnpm-store
          key: pnpm-napi-${{ hashFiles('pubmed-client-napi/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-napi-

      - name: Install NAPI dependencies
        run: pnpm install --frozen-lockfile
        working-directory: pubmed-client-napi

      - name: Build NAPI package (generates index.d.ts)
        run: pnpm run build:debug
        working-directory: pubmed-client-napi

      - name: Build Node.js docs
        run: pnpm run docs
        working-directory: pubmed-client-napi

      - name: Upload Node.js docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: node-docs
          path: pubmed-client-napi/docs/

  python-docs:
    name: Build Python Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5.4.2
        with:
          version: "0.8.x"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          workspaces: pubmed-client-py

      - name: Install Python dependencies
        run: uv sync --group docs
        working-directory: pubmed-client-py

      - name: Build Python package
        run: uv run --with maturin maturin develop
        working-directory: pubmed-client-py

      - name: Build Sphinx documentation
        run: uv run sphinx-build -b html docs/source docs/build/html
        working-directory: pubmed-client-py

      - name: Upload Python docs artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: python-docs
          path: pubmed-client-py/docs/build/html/

  build-site:
    name: Build GitHub Pages Site
    runs-on: ubuntu-latest
    needs: [docs, node-docs, python-docs]
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup-repo
        with:
          lfs: "false"

      - name: Cache pnpm store
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.pnpm-store
          key: pnpm-website-${{ hashFiles('website/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-website-

      - name: Install website dependencies
        run: pnpm install --frozen-lockfile
        working-directory: website

      - name: Lint website
        run: pnpm run ci
        working-directory: website

      - name: Type check website
        run: pnpm run typecheck
        working-directory: website

      - name: Build Docusaurus site
        run: pnpm run build
        working-directory: website

      - name: Download Rust docs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: rust-docs
          path: website/build/rust/

      - name: Download Node.js docs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: node-docs
          path: website/build/node/

      - name: Download Python docs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: python-docs
          path: website/build/python/

      - name: Create Rust docs redirect
        run: |
          printf '<html><head><meta http-equiv="refresh" content="0;url=pubmed_client/index.html"></head><body><a href="pubmed_client/index.html">Rust API docs</a></body></html>' \
            > website/build/rust/index.html

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: website/build/

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-site
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
