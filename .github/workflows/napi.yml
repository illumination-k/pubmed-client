name: NAPI-RS CI

on:
  push:
    branches: [main]
    tags:
      - "node-v*" # npm package version tags (e.g., node-v0.1.0)
    paths:
      - "pubmed-client-napi/**"
      - "pubmed-client/src/**"
      - "pubmed-client/Cargo.toml"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/napi.yml"
      - ".github/actions/setup-repo/**"
  pull_request:
    branches: [main]
    paths:
      - "pubmed-client-napi/**"
      - "pubmed-client/src/**"
      - "pubmed-client/Cargo.toml"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/napi.yml"
      - ".github/actions/setup-repo/**"
  workflow_dispatch: # Allow manual trigger for testing

env:
  CARGO_TERM_COLOR: always
  DEBUG: napi:*
  APP_NAME: pubmed-client
  MACOSX_DEPLOYMENT_TARGET: "10.13"
  SKIP_POSTINSTALL: "1"

permissions:
  contents: read
  id-token: write # Required for npm provenance

jobs:
  lint:
    permissions:
      contents: read
    timeout-minutes: 10
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pubmed-client-napi

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          fetch-depth: 0
          persist-credentials: false

      - name: Setup repository environment
        uses: ./.github/actions/setup-repo

      - name: Install pnpm dependencies
        run: pnpm install

      - name: Biome lint and typecheck
        run: pnpm run ci
  build:
    permissions:
      contents: read
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
            build: pnpm build --target x86_64-apple-darwin
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            build: pnpm build --target x86_64-pc-windows-msvc
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            build: pnpm build --target x86_64-unknown-linux-gnu
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build: pnpm build --target x86_64-unknown-linux-musl -x
          - host: macos-latest
            target: aarch64-apple-darwin
            build: pnpm build --target aarch64-apple-darwin
          - host: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            build: pnpm build --target aarch64-unknown-linux-gnu -x
          - host: ubuntu-latest
            target: aarch64-unknown-linux-musl
            build: pnpm build --target aarch64-unknown-linux-musl -x

    name: Build - ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}
    defaults:
      run:
        working-directory: pubmed-client-napi

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          fetch-depth: 0
          persist-credentials: false

      - name: Setup repository environment
        uses: ./.github/actions/setup-repo
        with:
          rust-target: ${{ matrix.settings.target }}

      - name: Install pnpm dependencies
        run: pnpm install

      # Setup zig for cross-compilation (musl and aarch64-linux-gnu)
      - name: Setup zig
        if: contains(matrix.settings.target, 'musl') || matrix.settings.target == 'aarch64-unknown-linux-gnu'
        uses: mlugg/setup-zig@fa65c4058643678a4e4a9a60513944a7d8d35440 # v2.1.0 # zizmor: ignore[cache-poisoning]
        with:
          version: 0.14.1
          cache-key: ${{ runner.os }}-${{ matrix.settings.target }}

      - name: Install cargo-zigbuild
        if: contains(matrix.settings.target, 'musl') || matrix.settings.target == 'aarch64-unknown-linux-gnu'
        uses: taiki-e/install-action@e0db384ad69f5ba2c6dd0129d8934e0d0ba465c1 # v2.65.10
        with:
          tool: cargo-zigbuild

      - name: Build
        run: ${{ matrix.settings.build }}

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: bindings-${{ matrix.settings.target }}
          path: |
            pubmed-client-napi/*.node
            pubmed-client-napi/index.js
            pubmed-client-napi/index.d.ts
          if-no-files-found: error

  test:
    permissions:
      contents: read
    timeout-minutes: 10
    name: Test
    runs-on: ubuntu-latest
    needs: [build, lint]
    defaults:
      run:
        working-directory: pubmed-client-napi

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          fetch-depth: 0
          persist-credentials: false

      - name: Setup repository environment
        uses: ./.github/actions/setup-repo

      - name: Install pnpm dependencies
        run: pnpm install

      - name: Download artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: bindings-x86_64-unknown-linux-gnu
          path: .

      - name: Run tests
        run: pnpm test

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    # Run on tags for release and workflow_dispatch for dry-run testing
    if: startsWith(github.ref, 'refs/tags/node-v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write # Required for GitHub release creation
      id-token: write
    timeout-minutes: 15
    defaults:
      run:
        working-directory: pubmed-client-napi

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true
          fetch-depth: 0
          persist-credentials: false

      - name: Setup repository environment
        uses: ./.github/actions/setup-repo

      - name: Setup Node.js for npm publishing
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Install pnpm dependencies
        run: pnpm install

      # Note: download-artifact's path is relative to repo root, not working-directory
      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: bindings-*
          path: pubmed-client-napi/artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/*.node || echo "No .node files found"
      - name: Create npm directories
        run: pnpm run create-npm-dirs

      - name: Move artifacts to platform directories
        run: pnpm run artifacts

      - name: Prepare npm packages (dry-run)
        if: github.event_name == 'workflow_dispatch'
        run: pnpm run prepublishOnly --dry-run

      - name: Publish dry-run platform packages
        if: github.event_name == 'workflow_dispatch'
        run: |
          for pkg in npm/*/; do
            echo "Dry-run publishing $pkg"
            cd "$pkg"
            npm publish --dry-run --access public
            cd ../..
          done

      - name: Publish dry-run main package
        if: github.event_name == 'workflow_dispatch'
        run: npm publish --dry-run --access public

      - name: Prepare npm packages
        if: startsWith(github.ref, 'refs/tags/node-v')
        run: pnpm run prepublishOnly --skip-optional-publish

      - name: Publish platform packages
        if: startsWith(github.ref, 'refs/tags/node-v')
        run: |
          for pkg in npm/*/; do
            echo "Publishing $pkg"
            cd "$pkg"
            npm publish --provenance --access public
            cd ../..
          done

      - name: Publish main package
        if: startsWith(github.ref, 'refs/tags/node-v')
        run: npm publish --provenance --access public
