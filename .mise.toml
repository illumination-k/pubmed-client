[tools]
pre-commit = "latest"
dprint = "latest"

pnpm = "10"
node = "20"
uv = "0.8"

shfmt = "3"

# github actions ci
actionlint = "1.7.7"
"pipx:zizmor" = "1.9.0"
shellcheck = "0.10.0"
"aqua:suzuki-shunsuke/ghalint" = "1.4.1"
"aqua:suzuki-shunsuke/pinact" = "3.3.0"

[env]
# Use Python from pubmed-client-py venv for PyO3
PYO3_PYTHON = "{{config_root}}/pubmed-client-py/.venv/bin/python"
# Allow PyO3 to work with Python 3.14 (forward compatibility)
PYO3_USE_ABI3_FORWARD_COMPATIBILITY = "1"

[hooks]
postinstall = ["bash ./etc/postinstall.sh"]

[tasks."fmt:root"]
description = "Format Rust code at workspace root using mise, dprint, and cargo fmt"
env = { RUST_LOG = "warn" }
run = ["mise fmt", "dprint fmt", "cargo fmt --all", "pinact run"]

[tasks."fmt:sh"]
description = "Format shell scripts with shfmt"
run = ["shfmt -w ./**/*.sh"]

[tasks.fmt]
description = "Format all code (Rust + Python + TS packages)"
depends = [
  "fmt:root",
  "py:format",
  "fmt:sh",
  "napi:fmt",
  "wasm:fmt",
  "website:fmt",
]

[tasks."lint:root"]
description = "Lint Rust code with dprint, cargo fmt, and clippy"
run = [
  "actionlint",
  "ghalint run",
  "zizmor .",
  "dprint check",
  "cargo fmt --all -- --check",
  "cargo clippy --workspace --all-targets -- -D warnings",
  "cargo clippy -p pubmed-client --all-targets --features integration-tests -- -D warnings",
]

[tasks.lint]
description = "Lint all code (Rust + Python + TS packages)"
depends = ["lint:root", "py:lint", "napi:lint", "wasm:lint", "website:lint"]

[tasks.setup]
description = "Run postinstall setup script"
run = ["bash ./etc/postinstall.sh"]

[tasks.test]
description = "Run tests for entire workspace using nextest"
run = ["cargo nextest run --workspace"]

[tasks.doctest]
description = "Run doc tests for core Rust library"
run = ["cargo test --doc -p pubmed-client"]

[tasks.build]
description = "Build entire workspace"
run = ["cargo build --workspace"]

[tasks.check]
description = "Check entire workspace without building"
run = ["cargo check --workspace"]

[tasks.coverage]
description = "Generate HTML coverage report with per-file text summary"
run = [
  "cargo llvm-cov nextest -p pubmed-client --all-features --no-report",
  "cargo llvm-cov report --html",
  "cargo llvm-cov report --text",
]

[tasks."wasm:build"]
description = "Build WASM package for web target"
run = ["cd pubmed-client-wasm && wasm-pack build --target web"]

[tasks."wasm:build:node"]
description = "Build WASM package for Node.js target"
run = ["cd pubmed-client-wasm && wasm-pack build --target nodejs"]

[tasks."wasm:test"]
description = "Build and test WASM package with TypeScript tests"
run = ["cd pubmed-client-wasm && pnpm run build && pnpm run test"]

[tasks."napi:build"]
description = "Build napi-rs native Node.js bindings"
dir = "pubmed-client-napi"
run = ["pnpm run build"]

[tasks."napi:test"]
description = "Build and run napi-rs TypeScript tests"
dir = "pubmed-client-napi"
run = ["pnpm run build && pnpm run test"]

[tasks."napi:fmt"]
description = "Format napi package code with Biome"
dir = "pubmed-client-napi"
run = ["pnpm run format"]

[tasks."napi:lint"]
description = "Run linting and type checking for napi package"
dir = "pubmed-client-napi"
run = ["pnpm run ci", "pnpm run typecheck"]

[tasks."wasm:fmt"]
description = "Format WASM package code with Biome"
dir = "pubmed-client-wasm"
run = ["pnpm run format"]

[tasks."wasm:lint"]
description = "Run Biome linting for WASM package"
dir = "pubmed-client-wasm"
run = ["pnpm run ci"]

[tasks."website:fmt"]
description = "Format website code with Biome"
dir = "website"
run = ["pnpm run format"]

[tasks."website:lint"]
description = "Run Biome linting and TypeScript type checking on website"
dir = "website"
run = ["pnpm run ci", "pnpm run typecheck"]

[tasks."core:test"]
description = "Run tests for core Rust library only"
run = ["cargo test -p pubmed-client"]

[tasks."core:test:integration"]
description = "Run integration tests for core library"
run = ["cd pubmed-client && cargo test --test"]

[tasks."py:build"]
description = "Build Python package with maturin"
dir = "pubmed-client-py"
run = ["uv run maturin build"]

[tasks."py:test"]
description = "Run Python tests with pytest"
dir = "pubmed-client-py"
run = ["uv run --frozen pytest"]

[tasks."py:lint"]
description = "Lint Python code with ruff and mypy"
env = { RUST_LOG = "warn" }
dir = "pubmed-client-py"
run = ["uv run --frozen ruff check", "uv run --frozen mypy ."]

[tasks."py:format"]
description = "Format Python code with ruff"
env = { RUST_LOG = "warn" }
dir = "pubmed-client-py"
run = ["uv run --frozen ruff format"]

[tasks."py:coverage"]
description = "Generate Python coverage report with HTML and terminal output"
dir = "pubmed-client-py"
run = [
  "uv run --frozen pytest --cov=pubmed_client --cov-report=html --cov-report=term",
]

[tasks."py:clean"]
description = "Clean Python build artifacts and cache directories"
dir = "pubmed-client-py"
run = [
  "rm -rf target/",
  "rm -rf .pytest_cache/",
  "rm -rf .mypy_cache/",
  "rm -rf .ruff_cache/",
  "rm -rf htmlcov/",
  "rm -rf .coverage",
]
