[tools]
pre-commit = "latest"
dprint = "latest"

# "cargo:cargo-nextest" = "latest"
# "cargo:cargo-llvm-cov" = "latest"

pnpm = "10"
node = "20"
uv = "0.8"

[env]
# Use Python from pubmed-client-py venv for PyO3
PYO3_PYTHON = "{{config_root}}/pubmed-client-py/.venv/bin/python"
# Allow PyO3 to work with Python 3.14 (forward compatibility)
PYO3_USE_ABI3_FORWARD_COMPATIBILITY = "1"

[hooks]
postinstall = ["mise run setup"]

[tasks."fmt:root"]
run = ["mise fmt", "dprint fmt", "cargo fmt --all"]

[tasks.fmt]
depends = ["fmt:root", "py:format"]

[tasks."lint:root"]
run = [
  "./etc/check_lfs_tracking.sh",
  "dprint check",
  "cargo fmt --all -- --check",
  "cargo clippy --workspace --all-targets -- -D warnings",
  "cargo clippy -p pubmed-client --all-targets --features integration-tests -- -D warnings",
]

[tasks.lint]
depends = ["lint:root", "py:check"]

[tasks."setup:pre-commit"]
run = ["pre-commit install --install-hooks"]

[tasks."setup:py"]
dir = "{{ config_root }}/pubmed-client-py"
run = ["uv venv"]

[tasks."setup:test"]
run = ["bash ./etc/setup-test.sh"]

[tasks.setup]
depends = ["setup:*"]

[tasks.test]
run = ["cargo nextest run --workspace"]

[tasks."test:watch"]
run = ["cargo watch -x 'nextest run --workspace'"]

[tasks."test:verbose"]
run = ["cargo nextest run --workspace --no-capture"]

[tasks.build]
run = ["cargo build --workspace"]

[tasks.check]
run = ["cargo check --workspace"]

[tasks.doc]
run = ["cargo doc --workspace --open"]

[tasks.coverage]
run = ["cargo llvm-cov nextest -p pubmed-client --all-features --html"]

[tasks."wasm:build"]
run = ["cd pubmed-client-wasm && wasm-pack build --target web"]

[tasks."wasm:build:node"]
run = ["cd pubmed-client-wasm && wasm-pack build --target nodejs"]

[tasks."wasm:test"]
run = ["cd pubmed-client-wasm && pnpm run build && pnpm run test"]

[tasks."wasm:publish"]
run = ["cd pubmed-client-wasm && pnpm run publish"]

[tasks."core:test"]
run = ["cargo test -p pubmed-client"]

[tasks."core:test:integration"]
run = ["cd pubmed-client && cargo test --test"]

[tasks."core:publish"]
run = ["cd pubmed-client && cargo publish"]

[tasks."py:build"]
dir = "pubmed-client-py"
run = ["uv run maturin build"]

[tasks."py:test"]
dir = "pubmed-client-py"
run = ["uv run --frozen pytest"]

[tasks."py:lint"]
dir = "pubmed-client-py"
run = ["uv run --frozen ruff check"]

[tasks."py:format"]
dir = "pubmed-client-py"
run = ["uv run --frozen ruff format"]

[tasks."py:typecheck"]
dir = "pubmed-client-py"
run = ["uv run --frozen mypy ."]

[tasks."py:check"]
depends = ["py:lint", "py:typecheck"]

[tasks."py:coverage"]
dir = "pubmed-client-py"
run = [
  "uv run --frozen pytest --cov=pubmed_client --cov-report=html --cov-report=term",
]

[tasks."py:clean"]
dir = "pubmed-client-py"
run = [
  "rm -rf target/",
  "rm -rf .pytest_cache/",
  "rm -rf .mypy_cache/",
  "rm -rf .ruff_cache/",
  "rm -rf htmlcov/",
  "rm -rf .coverage",
]

[tasks."py:publish"]
dir = "pubmed-client-py"
run = ["uv run maturin publish"]
