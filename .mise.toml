[tools]
pre-commit = "latest"
dprint = "latest"

# "cargo:cargo-nextest" = "latest"
# "cargo:cargo-llvm-cov" = "latest"

pnpm = "10"
node = "20"
uv = "0.8"

[env]
# Use Python from pubmed-client-py venv for PyO3
PYO3_PYTHON = "{{config_root}}/pubmed-client-py/.venv/bin/python"

[hooks]
postinstall = ["mise run setup"]

[tasks.fmt]
run = ["mise fmt", "dprint fmt", "cargo fmt --all"]

[tasks.lint]
run = [
  "dprint check",
  "cargo fmt --all -- --check",
  "cargo clippy --workspace --all-targets -- -D warnings",
  "cargo clippy -p pubmed-client-rs --all-targets --features integration-tests -- -D warnings",
]

[tasks."setup:py"]
dir = "{{ config_root }}/pubmed-client-py"
run = ["uv venv"]

[tasks."setup:test"]
run = ["bash ./etc/setup-test.sh"]

[tasks.setup]
depends = ["setup:*"]

[tasks.test]
run = ["cargo nextest run --workspace"]

[tasks."test:watch"]
run = ["cargo watch -x 'nextest run --workspace'"]

[tasks."test:verbose"]
run = ["cargo nextest run --workspace --no-capture"]

[tasks.build]
run = ["cargo build --workspace"]

[tasks.check]
run = ["cargo check --workspace"]

[tasks.doc]
run = ["cargo doc --workspace --open"]

[tasks.coverage]
run = ["cargo llvm-cov nextest -p pubmed-client-rs --all-features --html"]

[tasks."wasm:build"]
run = ["cd pubmed-client-wasm && wasm-pack build --target web"]

[tasks."wasm:build:node"]
run = ["cd pubmed-client-wasm && wasm-pack build --target nodejs"]

[tasks."wasm:test"]
run = ["cd pubmed-client-wasm && pnpm run build && pnpm run test"]

[tasks."wasm:publish"]
run = ["cd pubmed-client-wasm && pnpm run publish"]

[tasks."core:test"]
run = ["cargo test -p pubmed-client-rs"]

[tasks."core:test:integration"]
run = ["cd pubmed-client && cargo test --test"]

[tasks."core:publish"]
run = ["cd pubmed-client && cargo publish"]

[tasks."py:build"]
dir = "pubmed-client-py"
run = ["uv run maturin build"]

[tasks."py:test"]
dir = "pubmed-client-py"
run = ["uv run pytest"]

[tasks."py:lint"]
dir = "pubmed-client-py"
run = ["uv run ruff check"]

[tasks."py:format"]
dir = "pubmed-client-py"
run = ["uv run ruff format"]

[tasks."py:typecheck"]
dir = "pubmed-client-py"
run = ["uv run mypy"]

[tasks."py:check"]
dir = "pubmed-client-py"
run = ["uv run ruff check .", "uv run ruff format --check .", "uv run mypy ."]

[tasks."py:coverage"]
dir = "pubmed-client-py"
run = ["uv run pytest --cov=pubmed_client --cov-report=html --cov-report=term"]

[tasks."py:clean"]
dir = "pubmed-client-py"
run = [
  "rm -rf target/",
  "rm -rf .pytest_cache/",
  "rm -rf .mypy_cache/",
  "rm -rf .ruff_cache/",
  "rm -rf htmlcov/",
  "rm -rf .coverage",
]

[tasks."py:publish"]
dir = "pubmed-client-py"
run = ["uv run maturin publish"]
