# Loaded with MISE_ENV=root
# Repository infrastructure tools: formatting, linting, CI auditing
# Used by: lint.yml, and local development

[tools]
pre-commit = "latest"
dprint = "latest"
shfmt = "3"
actionlint = "1.7.7"
"pipx:zizmor" = "1.9.0"
shellcheck = "0.10.0"
"aqua:suzuki-shunsuke/ghalint" = "1.4.1"
"aqua:suzuki-shunsuke/pinact" = "3.3.0"

# ── Format tasks ──────────────────────────────────────────────────────────────

[tasks."fmt:root"]
description = "Format Rust code (dprint + cargo fmt + pinact)"
run = ["mise fmt", "dprint fmt", "cargo fmt --all", "pinact run"]

[tasks."fmt:sh"]
description = "Format shell scripts with shfmt"
run = ["shfmt -w ./**/*.sh"]

[tasks.fmt]
description = "Format all code (runs fmt:* tasks from active environments)"
depends = ["fmt:*"]

# ── Lint tasks ────────────────────────────────────────────────────────────────

[tasks."lint:root"]
description = "Lint Rust and GitHub Actions (dprint, clippy, actionlint, ghalint, zizmor)"
run = [
  "actionlint",
  "ghalint run",
  "zizmor .",
  "dprint check",
  "cargo fmt --all -- --check",
  "cargo clippy --workspace --all-targets -- -D warnings",
  "cargo clippy -p pubmed-client --all-targets --features integration-tests -- -D warnings",
]

[tasks.lint]
description = "Lint all code (runs lint:* tasks from active environments)"
depends = ["lint:*"]

# ── CI-equivalent aggregate task ──────────────────────────────────────────────

[tasks."ci:all"]
description = "Run all CI checks locally (requires MISE_ENV=root,rust,node,python)"
run = [
  "mise run lint",
  "MISE_ENV=rust mise run ci:rust",
  "MISE_ENV=python mise run ci:py",
  "MISE_ENV=node mise run ci:napi",
  "MISE_ENV=node mise run ci:wasm",
]
