# Loaded with MISE_ENV=rust
# Rust-specific test tooling and workspace tasks
# Used by: rust.yml, integration-tests.yml

[tools]
"cargo:cargo-nextest" = "latest"
"cargo:cargo-llvm-cov" = "latest"

[tasks."fmt:rs"]
description = "Format Rust code with cargo fmt"
run = ["cargo fmt --all"]

[tasks."lint:rs"]
description = "Lint Rust code with cargo clippy"
run = [
  "cargo fmt --all -- --check",
  "cargo clippy --workspace --all-targets -- -D warnings",
]

[tasks."test:rs"]
description = "Run tests for entire workspace using nextest"
run = ["cargo nextest run --workspace"]

[tasks."doctest:rs"]
description = "Run doc tests for entire workspace"
run = ["cargo test --doc --workspace --exclude pubmed-client-py"]

[tasks."build:rs"]
description = "Build entire workspace"
run = ["cargo build --workspace"]

[tasks."check:rs"]
description = "Check entire workspace without building"
run = ["cargo check --workspace"]

[tasks."coverage:rs"]
description = "Generate HTML coverage report (llvm-cov)"
run = [
  "cargo llvm-cov nextest --workspace --all-features --no-report",
  "cargo llvm-cov report --html",
  "cargo llvm-cov report --text",
]

[tasks."bench:rs"]
description = "Run all pubmed-parser criterion benchmarks"
run = ["cargo bench -p pubmed-parser"]

[tasks."bench:save"]
description = "Run benchmarks and save as a named baseline (usage: mise r bench:save <name>)"
run = "cargo bench -p pubmed-parser -- --save-baseline {{arg(i=0, name='baseline_name')}}"

[tasks."bench:compare"]
description = "Run benchmarks comparing against a saved baseline (usage: mise r bench:compare <name>)"
run = "cargo bench -p pubmed-parser -- --baseline {{arg(i=0, name='baseline_name')}}"

[tasks."profile:rs"]
description = "Build and profile parsing with samply (usage: mise r profile:rs [pmc|pubmed|all])"
run = """
cargo build --profile profiling --example profile_parsing -p pubmed-parser
samply record target/profiling/examples/profile_parsing {{arg(i=0, name='mode', default='all')}}
"""

[tasks."ci:rs"]
description = "Equivalent to rust.yml: unit tests + doc tests"
depends = ["lint:rs", "test:rs", "doctest:rs"]
